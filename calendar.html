<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Resource Calendar</title>
</head>
<body>
<div style="padding:20px;">
    <div id="icalendar">
    </div>
</div>
<script>
class iCalendar {
    constructor(options = {}) {
        this.weekMode = options.weekMode || false;
        this.showDate = (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
        this.startHm = options.startHm || 800;
        this.endHm = options.endHm || 2200;
        this.interval = options.interval || 5;
        this.maxHeight = options.maxHeight || 360;
    }

    initialize(resources, events) {
        this.resources = resources;
        this.events = events;
  
        const calendar = document.getElementById('icalendar');
        calendar.style.position = 'relative';
        calendar.style.fontFamily = 'Arial, sans-serif';
        calendar.style.border = '1px solid #e6e6e6';
        calendar.style.boxSizing = 'border-box';
        calendar.style.overflow = 'hidden';
        
        // remove existing elements if they exist
        calendar.querySelectorAll('.fixed-corner').forEach(corner => corner.remove());
        calendar.querySelectorAll('.fixed-header').forEach(header => header.remove());
        calendar.querySelectorAll('.fixed-left').forEach(left => left.remove());
        calendar.querySelectorAll('.fixed-slots').forEach(slots => slots.remove());
        
        // Create a table element for controls
        const controlsTable = document.createElement('table');
        controlsTable.style.width = '100%';

        // Create the first row
        const row = document.createElement('tr');

        // Create the first cell with Prev and Next buttons
        const leftCell = document.createElement('td');
        leftCell.style.width = '30%';
        leftCell.style.textAlign = 'left';

        // Create Prev button
        const prevButton = document.createElement('button');
        prevButton.type = 'button';
        prevButton.textContent = 'Prev';
        prevButton.style.display = 'inline-block';
        prevButton.style.border = '1px solid #e6e6e6';
        prevButton.style.padding = '4px 8px';
        prevButton.style.marginRight = '4px';
        prevButton.style.borderRadius = '4px';
        prevButton.style.background = '#f6f6f6';
        prevButton.style.verticalAlign = 'middle';
        prevButton.style.cursor = 'pointer';
        prevButton.onclick = () => {
            let dateObj = new Date(this.showDate);
            // Add one day to the date
            dateObj.setDate(dateObj.getDate() - 1);
            // Format the updated date as a string
            this.showDate = dateObj.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
            
            this.refresh();
        };

        // Create Next button
        const nextButton = document.createElement('button');
        nextButton.type = 'button';
        nextButton.textContent = 'Next';
        nextButton.style.display = 'inline-block';
        nextButton.style.border = '1px solid #e6e6e6';
        nextButton.style.padding = '4px 8px';
        nextButton.style.borderRadius = '4px';
        nextButton.style.background = '#f6f6f6';
        nextButton.style.verticalAlign = 'middle';
        nextButton.style.cursor = 'pointer';
        nextButton.onclick = () => {
            let dateObj = new Date(this.showDate);
            // Add one day to the date
            dateObj.setDate(dateObj.getDate() + 1);
            // Format the updated date as a string
            this.showDate = dateObj.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
            
            this.refresh();
        };

        // Append buttons to the left cell
        leftCell.appendChild(prevButton);
        leftCell.appendChild(nextButton);

        // Create the center cell with date display
        const centerCell = document.createElement('td');
        centerCell.style.textAlign = 'center';
        if (this.weekMode) {
            const tempDate = new Date(this.showDate);
            tempDate.setDate(tempDate.getDate() + 7);
            centerCell.innerHTML = `<strong id="icalendar-showdate">From ${this.getYmd(this.showDate)} To ${this.getYmd(tempDate)}</strong>`;
        } else {
            centerCell.innerHTML = `<strong id="icalendar-showdate">${this.getYmd(this.showDate, true)}</strong>`;
        }

        // Create the right cell with Week and Daily buttons
        const rightCell = document.createElement('td');
        rightCell.style.width = '30%';
        rightCell.style.textAlign = 'right';

        // Create Week button
        const weekButton = document.createElement('button');
        weekButton.type = 'button';
        weekButton.textContent = 'Week';
        weekButton.style.display = 'inline-block';
        weekButton.style.border = '1px solid #e6e6e6';
        weekButton.style.padding = '4px 8px';
        weekButton.style.borderRadius = '4px';
        weekButton.style.background = '#f6f6f6';
        weekButton.style.verticalAlign = 'middle';
        weekButton.style.cursor = 'pointer';
        weekButton.onclick = () => {
            this.weekMode = true;
            
            this.refresh();
        };

        // Create Daily button
        const dailyButton = document.createElement('button');
        dailyButton.type = 'button';
        dailyButton.textContent = 'Daily';
        dailyButton.style.display = 'inline-block';
        dailyButton.style.border = '1px solid #e6e6e6';
        dailyButton.style.padding = '4px 8px';
        dailyButton.style.marginLeft = '4px';
        dailyButton.style.borderRadius = '4px';
        dailyButton.style.background = '#f6f6f6';
        dailyButton.style.verticalAlign = 'middle';
        dailyButton.style.cursor = 'pointer';
        dailyButton.onclick = () => {
            this.weekMode = false;
            
            this.refresh();
        };

        // Append buttons to the right cell
        rightCell.appendChild(weekButton);
        rightCell.appendChild(dailyButton);

        // Append all cells to the row
        row.appendChild(leftCell);
        row.appendChild(centerCell);
        row.appendChild(rightCell);

        // Append the row to the table
        controlsTable.appendChild(row);

        // Create a container for the controls and style it
        const newControls = document.createElement('div');
        newControls.style.padding = '10px';
        newControls.style.border = '1px solid #e6e6e6';
        newControls.style.boxSizing = 'border-box';

        // Append the table to the new controls container
        newControls.appendChild(controlsTable);

        // Append the new controls to the calendar
        calendar.appendChild(newControls);

        
        const newBody = document.createElement('div');
        newBody.style.position = 'relative';
        newBody.style.background = '#f6f6f6';
        newBody.style.overflow = 'hidden';
        
        const newfixedCorner = document.createElement('div');
        newfixedCorner.className = 'fixed-corner';

        const newfixedHeader = document.createElement('div');
        newfixedHeader.className = 'fixed-header';

        const newfixedLeft = document.createElement('div');
        newfixedLeft.className = 'fixed-left';

        const newslots = document.createElement('div');
        newslots.className = 'slots';

        // Append the elements to the iCalendar div
        newBody.appendChild(newfixedCorner);
        newBody.appendChild(newfixedHeader);
        newBody.appendChild(newfixedLeft);
        newBody.appendChild(newslots);
        calendar.appendChild(newBody);

        this.fixedCorner = calendar.querySelector('.fixed-corner');
        this.fixedHeader = calendar.querySelector('.fixed-header');
        this.fixedLeft = calendar.querySelector('.fixed-left');
        this.slots = calendar.querySelector('.slots');

        this.applyStyles();
        this.setHeader();
        this.setLeft();
        this.setSlots();
        this.syncScroll();
        this.drawEvents(events);
    }
    
    refresh() {
        if (this.weekMode) {
            const tempDate = new Date(this.showDate);
            tempDate.setDate(tempDate.getDate() + 7);
            document.getElementById('icalendar-showdate').innerHTML = `From ${this.getYmd(this.showDate)} To ${this.getYmd(tempDate)}`;
        } else {
            document.getElementById('icalendar-showdate').innerHTML = `${this.getYmd(this.showDate, true)}`;
        }
        
        this.setHeader();
        this.setLeft();
        this.setSlots();

        this.drawEvents(this.events);
    }

    applyStyles() {
        // Apply styles to fixed-corner
        this.fixedCorner.style.position = 'absolute';
        this.fixedCorner.style.background = '#f6f6f6';
        this.fixedCorner.style.top = '0px';
        this.fixedCorner.style.left = '0px';
        this.fixedCorner.style.width = '61px';
        this.fixedCorner.style.height = '47px';
        this.fixedCorner.style.border = '1px solid #e6e6e6';
        this.fixedCorner.style.boxSizing = 'border-box';
        this.fixedCorner.style.zIndex = '3';
        
        // Apply styles to fixed-header
        this.fixedHeader.style.position = 'absolute';
        this.fixedHeader.style.top = '0px';
        this.fixedHeader.style.left = '0px';
        this.fixedHeader.style.width = '100%';
        this.fixedHeader.style.boxSizing = 'border-box';
        this.fixedHeader.style.overflowX = 'hidden';
        this.fixedHeader.style.overflowY = 'scroll';
        this.fixedHeader.style.zIndex = '2';

        // Apply styles to fixed-left
        this.fixedLeft.style.position = 'absolute';
        this.fixedLeft.style.top = '46px';
        this.fixedLeft.style.left = '0px';
        this.fixedLeft.style.maxHeight = this.maxHeight + 'px';
        this.fixedLeft.style.boxSizing = 'border-box';
        this.fixedLeft.style.zIndex = '1';

        // Apply styles to slots
        this.slots.style.position = 'relative';
        this.slots.style.background = '#fff';
        this.slots.style.maxHeight = this.maxHeight + 'px';
        this.slots.style.marginTop = '46px';
        this.slots.style.marginLeft = '61px';
        this.slots.style.boxSizing = 'border-box';
        this.slots.style.overflowX = 'auto';
        this.slots.style.overflowY = 'scroll';
    }

    setHeader() {
        const calendarTable = document.createElement('table');
        calendarTable.style.borderCollapse = 'collapse';
        calendarTable.style.width = '100%';
        calendarTable.style.fontSize = '13px';
        calendarTable.style.boxSizing = 'border-box';
        const calendarThead = document.createElement('thead');
        const calendarRow = document.createElement('tr');
  
        if(this.resources) {
            this.resources.forEach((resource, index) => {
                if(this.weekMode) {
                    let currentDate = new Date(this.showDate);
                    for (let w = 0; w < 7; w++) {
                        let calendarCol = null;

                        if (index === 0 && w === 0) {
                            calendarCol = document.createElement('th');
                            calendarCol.style.position = 'relative';
                            calendarCol.style.background = '#f6f6f6';
                            calendarCol.style.width = '60px';
                            calendarCol.style.minWidth = '60px';
                            calendarCol.style.height = '46px';
                            calendarCol.style.padding = '4px';
                            calendarCol.style.border = '1px solid #e6e6e6';
                            calendarCol.style.boxSizing = 'border-box';
                            calendarCol.innerHTML = '<strong><span>&nbsp;</span></strong>';
                            calendarRow.appendChild(calendarCol);
                        }

                        calendarCol = document.createElement('th');
                        calendarCol.style.position = 'relative';
                        calendarCol.style.background = '#f6f6f6';
                        calendarCol.style.width = `calc((100% - 60px) / ${this.resources.length})`;
                        calendarCol.style.minWidth = '180px';
                        calendarCol.style.height = '46px';
                        calendarCol.style.padding = '4px';
                        calendarCol.style.border = '1px solid #e6e6e6';
                        calendarCol.style.boxSizing = 'border-box';
                        calendarCol.innerHTML = `<strong><span>${resource.name}<br/><small>`+this.getYmd(currentDate, true)+`</small></span></strong>`;
                        calendarRow.appendChild(calendarCol);
                   
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
                else {
                    let calendarCol = null;

                    if (index === 0) {
                        calendarCol = document.createElement('th');
                        calendarCol.style.position = 'relative';
                        calendarCol.style.background = '#f6f6f6';
                        calendarCol.style.width = '60px';
                        calendarCol.style.minWidth = '60px';
                        calendarCol.style.height = '46px';
                        calendarCol.style.padding = '4px';
                        calendarCol.style.border = '1px solid #e6e6e6';
                        calendarCol.style.boxSizing = 'border-box';
                        calendarCol.innerHTML = '<strong><span>&nbsp;</span></strong>';
                        calendarRow.appendChild(calendarCol);
                    }

                    calendarCol = document.createElement('th');
                    calendarCol.style.position = 'relative';
                    calendarCol.style.background = '#f6f6f6';
                    calendarCol.style.width = `calc((100% - 60px) / ${this.resources.length})`;
                    calendarCol.style.minWidth = '180px';
                    calendarCol.style.height = '46px';
                    calendarCol.style.padding = '4px';
                    calendarCol.style.border = '1px solid #e6e6e6';
                    calendarCol.style.boxSizing = 'border-box';
                    calendarCol.innerHTML = `<strong><span>${resource.name}</span></strong>`;
                    calendarRow.appendChild(calendarCol);
                }
            });
        }

        calendarThead.appendChild(calendarRow);
        calendarTable.appendChild(calendarThead);
        this.fixedHeader.innerHTML = '';
        this.fixedHeader.appendChild(calendarTable);
    }

    setLeft() {
        const calendarTable = document.createElement('table');
        calendarTable.style.borderCollapse = 'collapse';
        calendarTable.style.fontSize = '13px';
        calendarTable.style.boxSizing = 'border-box';
        const calendarThead = document.createElement('thead');
        let currentTime = this.startHm;

        while (currentTime <= this.endHm) {
            const calendarRow = document.createElement('tr');
            const calendarCol = document.createElement('th');
            calendarCol.style.position = 'relative';
            calendarCol.style.background = '#f6f6f6';
            calendarCol.style.width = '60px';
            calendarCol.style.height = '30px';
            calendarCol.style.padding = '4px';
            calendarCol.style.border = '1px solid #e6e6e6';
            calendarCol.style.boxSizing = 'border-box';

            // Format the current time in HH:mm format
            const timeString = currentTime.toString().padStart(4, '0');
            const formattedTime = `${timeString.slice(0, 2)}:${timeString.slice(2)}`;
            calendarCol.innerHTML = `<span>${formattedTime}</span>`;

            calendarRow.appendChild(calendarCol);
            calendarThead.appendChild(calendarRow);

            // Calculate the next time slot
            currentTime = this.getNextTimeSlot(currentTime, this.interval);
        }

        calendarTable.appendChild(calendarThead);
        this.fixedLeft.innerHTML = '';
        this.fixedLeft.appendChild(calendarTable);
    }

    setSlots() {
        const calendarTable = document.createElement('table');
        calendarTable.style.borderCollapse = 'collapse';
        calendarTable.style.width = '100%';
        calendarTable.style.fontSize = '12px';
        calendarTable.style.boxSizing = 'border-box';
        const calendarTbody = document.createElement('tbody');
        let currentTime = this.startHm;

        while (currentTime <= this.endHm) {
            const calendarRow = document.createElement('tr');
            if (this.resources) {
                this.resources.forEach((resource, index) => {
                    if (this.weekMode) {
                        let currentDate = new Date(this.showDate);
                        for (let w = 0; w < 7; w++) {
                            let calendarCol = null;

                            if (index === 0 && w === 0) {
                                calendarCol = document.createElement('td');
                                calendarCol.style.position = 'relative';
                                calendarCol.style.background = '#f6f6f6';
                                calendarCol.style.width = '60px';
                                calendarCol.style.minWidth = '60px';
                                calendarCol.style.height = '30px';
                                calendarCol.style.padding = '4px';
                                calendarCol.style.border = '1px solid #e6e6e6';
                                calendarCol.style.boxSizing = 'border-box';
                                // Display the time slot in HH:mm format
                                const timeString = currentTime.toString().padStart(4, '0');
                                const formattedTime = `${timeString.slice(0, 2)}:${timeString.slice(2)}`;
                                calendarCol.innerHTML = `<span>${formattedTime}</span>`;
                                //calendarRow.appendChild(calendarCol);
                            }

                            calendarCol = document.createElement('td');
                            calendarCol.style.position = 'relative';
                            calendarCol.style.background = '#fff';
                            calendarCol.style.width = `calc((100% - 60px) / ${this.resources.length})`;
                            calendarCol.style.minWidth = '180px';
                            calendarCol.style.height = '30px';
                            calendarCol.style.padding = '4px';
                            calendarCol.style.border = '1px solid #e6e6e6';
                            calendarCol.style.boxSizing = 'border-box';
                            calendarCol.setAttribute('data-rsindex', `${resource.id}_` + this.getYmd(currentDate) + `_${currentTime}`);
                            calendarRow.appendChild(calendarCol);

                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    } else {
                        let calendarCol = null;

                        if (index === 0) {
                            calendarCol = document.createElement('td');
                            calendarCol.style.position = 'relative';
                            calendarCol.style.background = '#f6f6f6';
                            calendarCol.style.width = '60px';
                            calendarCol.style.minWidth = '60px';
                            calendarCol.style.height = '30px';
                            calendarCol.style.padding = '4px';
                            calendarCol.style.border = '1px solid #e6e6e6';
                            calendarCol.style.boxSizing = 'border-box';
                            // Display the time slot in HH:mm format
                            const timeString = currentTime.toString().padStart(4, '0');
                            const formattedTime = `${timeString.slice(0, 2)}:${timeString.slice(2)}`;
                            calendarCol.innerHTML = `<span>${formattedTime}</span>`;
                            //calendarRow.appendChild(calendarCol);
                        }

                        calendarCol = document.createElement('td');
                        calendarCol.style.position = 'relative';
                        calendarCol.style.background = '#fff';
                        calendarCol.style.width = `calc((100% - 60px) / ${this.resources.length})`;
                        calendarCol.style.minWidth = '180px';
                        calendarCol.style.height = '30px';
                        calendarCol.style.padding = '4px';
                        calendarCol.style.border = '1px solid #e6e6e6';
                        calendarCol.style.boxSizing = 'border-box';
                        calendarCol.setAttribute('data-rsindex', `${resource.id}_` + this.getYmd(this.showDate) + `_${currentTime}`);
                        calendarRow.appendChild(calendarCol);
                    }
                });
            }

            calendarTbody.appendChild(calendarRow);
            // Calculate the next time slot
            currentTime = this.getNextTimeSlot(currentTime, this.interval);
        }

        calendarTable.appendChild(calendarTbody);
        this.slots.innerHTML = '';
        this.slots.appendChild(calendarTable);
    }

    syncScroll() {
        this.slots.addEventListener('scroll', () => {
            this.fixedHeader.querySelector('table').style.transform = `translateX(${-this.slots.scrollLeft}px)`;
            this.fixedLeft.querySelector('table').style.transform = `translateY(${-this.slots.scrollTop}px)`;
        });
    }

    drawEvents(events) {
        this.events = events;
        
        // Clear all existing events
        this.slots.querySelectorAll('.ievent').forEach(event => event.remove());

        if (events) {
            events.forEach(event => {
                // Find the matching slot using the event's resourceId, targetDate, and startHm
                const findMatchSlot = this.slots.querySelector(`[data-rsindex="${event.resourceId}_${event.targetDate}_${event.startHm}"]`);
                if (findMatchSlot) {
                    // Count how many blocks are already present in the slot to determine the position
                    const blockCount = findMatchSlot.querySelectorAll('.ievent').length;

                    // Create a new event block
                    const block = document.createElement('div');
                    block.className = 'ievent';
                    block.style.position = 'absolute';
                    block.style.background = event.background || '#3788d8';
                    block.style.top = '0px';
                    block.style.left = `${blockCount * 40}px`;
                    block.style.width = blockCount > 0 ? `calc(100% - ${blockCount * 40}px)` : '100%';

                    // Convert startHm and endHm to minutes since midnight
                    const startMinutes = Math.floor(event.startHm / 100) * 60 + (event.startHm % 100);
                    const endMinutes = Math.floor(event.endHm / 100) * 60 + (event.endHm % 100);

                    // Calculate the duration in minutes
                    const durationMinutes = endMinutes - startMinutes;

                    // Calculate the height based on the number of intervals
                    const height = (Math.ceil(durationMinutes / this.interval) + 1) * 30;
    
                    block.style.height = `${height}px`;
                    block.style.padding = '8px';
                    block.style.border = '1px solid #fff';
                    block.style.borderRadius = '8px';
                    block.style.boxShadow = '0px 0px 8px rgba(0, 0, 0, 0.4)';
                    block.style.boxSizing = 'border-box';
                    block.style.overflow = 'hidden';
                    block.style.opacity = '0.95';
                    block.style.zIndex = 1;

                    // Set the event content
                    block.innerHTML = `<div>${event.content}</div>`;

                    // Append the block to the matching slot
                    findMatchSlot.appendChild(block);
                }
            });
        }
    }

    getYmd(date, included_week) {
        // Convert the localized time back to a Date object
        const hongKongDate = new Date(date);

        // Define options to format the date including the weekday
        // Location code: en-US or zh-HK
        const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: 'Asia/Hong_Kong',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            weekday: 'short' // Add weekday to display day of the week
        });

        // Extract the date parts including the weekday
        const parts = formatter.formatToParts(hongKongDate);
        const year = parts.find(part => part.type === 'year').value;
        const month = parts.find(part => part.type === 'month').value;
        const day = parts.find(part => part.type === 'day').value;
        const weekday = parts.find(part => part.type === 'weekday').value.replace('星期', '').replace('週', '');  
        
        if(included_week) {
            return `${year}-${month}-${day} (${weekday})`;
            
        }
        else {
            return `${year}-${month}-${day}`;
        }
    }
    
    // calculate the next timeslot and handle minute overflow
    getNextTimeSlot(hm, interval) {
        let nextHm = hm + interval;
        if (nextHm % 100 >= 60) {
            nextHm = (Math.floor(nextHm / 100) + 1) * 100 + (nextHm % 100 - 60);
        }
        return nextHm;
    }
}

// Usage Example
const resources = [
    { id: 1, name: '會議室 A' },
    { id: 2, name: '會議室 B' },
    { id: 3, name: '會議室 C' },
    { id: 4, name: '會議室 D' },
    { id: 5, name: '會議室 E' }
];

const events = [
    { resourceId: 1, targetDate: '2024-09-03', startHm: 815, endHm: 950, content: '08:15 ~ 09:50', background: '#FFA726' },
    { resourceId: 1, targetDate: '2024-09-04', startHm: 815, endHm: 950, content: '08:15 ~ 09:50', background: '#FFA156' },
    { resourceId: 2, targetDate: '2024-09-03', startHm: 1000, endHm: 2200, content: '10:00 ~ 22:00', background: '#2A9D8F' },
    { resourceId: 3, targetDate: '2024-09-03', startHm: 1330, endHm: 1430, content: '13:30 ~ 14:30' },
    { resourceId: 1, targetDate: '2024-09-03', startHm: 915, endHm: 1045, content: '09:15 ~ 10:45', background: '#4C7B96' },
    { resourceId: 2, targetDate: '2024-09-03', startHm: 1000, endHm: 1430, content: '10:00 ~ 14:30' },
];
const icalendar = new iCalendar({ weekMode: true, startHm: 800, endHm: 2200, interval: 5, maxHeight: 680 });
icalendar.initialize(resources);
icalendar.drawEvents(events);
</script>
</body>
</html>
