<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Resource Calendar</title>
</head>
<body>
<div style="padding:20px;">
    <div id="icalendar">
    </div>
</div>
<script>
class iCalendar {
    constructor(config = {}) {
        this.elementID = config.elementID || 'icalendar';
        this.displayMode = config.displayMode || 'day';
        this.displayDate = (new Date(config.date || new Date())).toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
        this.startHm = config.startHm || 800;
        this.endHm = config.endHm || 2200;
        this.interval = config.interval || 5;
        this.maxHeight = config.maxHeight || 360;
        this.lang = config.lang || 'en';
    }

    init(resources, events) {
        this.resources = resources;
        this.events = events;

        const calendar = document.getElementById(this.elementID);
        this.setupElement(calendar);
        this.renderControls(calendar);
        this.renderBody(calendar);

        this.setHeader();
        this.setLeft();
        this.setSlots();
        this.drawEvents(events);
        this.syncScroll();
    }

    setupElement(calendar) {
        calendar.style.position = 'relative';
        calendar.style.fontFamily = 'Arial, sans-serif';
        calendar.style.fontSize = '13px';
        calendar.style.border = '1px solid #e6e6e6';
        calendar.style.boxSizing = 'border-box';
        calendar.style.overflow = 'hidden';
        // Clear existing elements
        ['.fixed-corner', '.fixed-header', '.fixed-left', '.timeSlots'].forEach(selector => {
            calendar.querySelectorAll(selector).forEach(el => el.remove());
        });
    }

    renderControls(calendar) {
        const controlsTable = this.createElement('table', { width: '100%' });
        const row = this.createElement('tr');
        const leftCell = this.createControlsLeftCell();
        const centerCell = this.createControlsCenterCell();
        const rightCell = this.createControlsRightCell();

        row.append(leftCell, centerCell, rightCell);
        controlsTable.appendChild(row);

        const controlsContainer = this.createElement('div', {
            position: 'relative',
            padding: '8px 4px',
            border: '1px solid #e6e6e6',
            boxSizing: 'border-box'
        });

        controlsContainer.appendChild(controlsTable);
        calendar.appendChild(controlsContainer);
    }

    createControlsLeftCell() {
        const cell = this.createElement('td', { width: '30%', textAlign: 'left' });
        const prevButton = this.createControlButton(this.lang === 'zh' ? '前一個' : 'Prev', () => this.changeDate(-1));
        const nextButton = this.createControlButton(this.lang === 'zh' ? '後一個' : 'Next', () => this.changeDate(1));

        cell.append(prevButton, nextButton);
        return cell;
    }

    createControlsCenterCell() {
        const cell = this.createElement('td', { textAlign: 'center' });
        cell.innerHTML = `<strong id="icalendar-showdate">${this.getDisplayDate()}</strong>`;
        return cell;
    }

    createControlsRightCell() {
        const cell = this.createElement('td', { width: '30%', textAlign: 'right' });
        const modes = [
            { text: this.lang === 'zh' ? '月' : 'Month', mode: 'month' },
            { text: this.lang === 'zh' ? '週' : 'Week', mode: 'week' },
            { text: this.lang === 'zh' ? '日' : 'Day', mode: 'day' }
        ];

        modes.forEach(({ text, mode }) => {
            const button = this.createControlButton(text, () => this.changeMode(mode));
            cell.appendChild(button);
        });

        return cell;
    }

    createControlButton(text, onClick) {
        const button = this.createElement('button', {
            type: 'button',
            display: 'inline-block',
            background: '#f6f6f6',
            padding: '4px 8px',
            marginLeft: '4px',
            marginRight: '4px',
            border: '1px solid #e6e6e6',
            boxSizing: 'border-box',
            borderRadius: '4px',
            verticalAlign: 'middle',
            cursor: 'pointer'
        });
        button.textContent = text;
        button.onclick = onClick;
        return button;
    }

    changeDate(offset) {
        let dateObj = new Date(this.displayDate);
        dateObj.setDate(dateObj.getDate() + offset);
        this.displayDate = dateObj.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
        this.refresh();
    }

    changeMode(mode) {
        this.displayMode = mode;
        this.refresh();
    }

    getDisplayDate() {
        if (this.displayMode === 'week') {
            const tempDate = new Date(this.displayDate);
            tempDate.setDate(tempDate.getDate() + 7);
            return this.lang === 'zh' ? 
                `由 ${this.getYmd(this.displayDate)} 至 ${this.getYmd(tempDate)}` : 
                `From ${this.getYmd(this.displayDate)} To ${this.getYmd(tempDate)}`;
        } else {
            return this.getYmd(this.displayDate, true);
        }
    }
    
    renderBody(calendar) {
        const body = this.createElement('div', {
            position: 'relative',
            background: '#f6f6f6',
            boxSizing: 'border-box',
            overflow: 'hidden'
        }, 'details');

        const fixedCorner = this.createElement('div', 
        {
            position: 'absolute', 
            background: '#f6f6f6', 
            top: '0px', 
            left: '0px',
            width: '61px', 
            height: '47px', 
            border: '1px solid #e6e6e6', 
            boxSizing: 'border-box',
            zIndex: '3'
        }, 'fixedCorner');
        
        const fixedHeader = this.createElement('div', 
        {
            position: 'absolute', 
            top: '0px', 
            left: '61px', 
            right: '0px',
            overflowX: 'hidden', 
            overflowY: 'scroll', 
            zIndex: '2'
        }, 'fixedHeader');
    
        const fixedLeft = this.createElement('div', 
        {
            position: 'absolute', 
            top: '46px', 
            left: '0px', 
            maxHeight: `${this.maxHeight}px`, 
            zIndex: '1'
        }, 'fixedLeft');
    
        const timeSlots = this.createElement('div', 
        {
            position: 'relative', 
            background: '#fff', 
            maxHeight: `${this.maxHeight}px`,
            marginTop: '46px', 
            marginLeft: '61px', 
            overflowX: 'auto', 
            overflowY: 'scroll'
        }, 'timeSlots');

        body.append(fixedCorner, fixedHeader, fixedLeft, timeSlots);
        calendar.appendChild(body);

        this.fixedCorner = fixedCorner;
        this.fixedHeader = fixedHeader;
        this.fixedLeft = fixedLeft;
        this.timeSlots = timeSlots;
    }

    createElement(tag, styles = {}, className = '') {
        const element = document.createElement(tag);
        if(className) {
            element.className = className;
        }
        Object.assign(element.style, styles);
        return element;
    }

    setHeader() {
        // Generate the title of the calendar based on the current display mode (year, month, day)
        this.fixedHeader.innerHTML = '';
        if (this.displayMode === 'week' || this.displayMode === 'day') {
            if(this.resources) {
                const headerTable = this.createElement('table', { width: '100%', borderCollapse: 'collapse' });
                const headerRow = this.createElement('tr');
                this.resources.forEach((resource, index) => {
                    if (this.displayMode === 'week') {
                        const startOfWeek = new Date(this.displayDate);
                        for (let w = 0; w < 7; w++) {
                            const day = new Date(startOfWeek);
                            day.setDate(startOfWeek.getDate() + w);
                            const dayCell = this.createElement('th', {
                                position: 'relative',
                                background: '#f6f6f6',
                                width: `calc((100% / ${this.resources.length})`,
                                minWidth: '180px',
                                height: '46px',
                                padding: '4px',
                                textAlign: 'center',
                                border: '1px solid #e6e6e6',
                                boxSizing: 'border-box',
                                textAlign: 'center'
                            });
                            dayCell.innerHTML = `${resource.name}<br/><small>`+this.getYmd(day, true)+`</small>`;
                            headerRow.appendChild(dayCell);
                        }
                    } else if (this.displayMode === 'day') {
                        const dayCell = this.createElement('th', {
                            position: 'relative',
                            background: '#f6f6f6',
                            width: `calc((100% / ${this.resources.length})`,
                            minWidth: '180px',
                            height: '46px',
                            padding: '4px',
                            textAlign: 'center',
                            border: '1px solid #e6e6e6',
                            boxSizing: 'border-box',
                            textAlign: 'center'
                        });
                        dayCell.innerHTML = `${resource.name}`;
                        headerRow.appendChild(dayCell);
                    }
                });
                
                headerTable.appendChild(headerRow);
                this.fixedHeader.appendChild(headerTable);
            }
        }
        else if (this.displayMode === 'month') {
            const headerTable = this.createElement('table', { width: '100%', borderCollapse: 'collapse' });
            const headerRow = this.createElement('tr');
            const daysOfWeek = this.lang === 'zh' ? ['日', '一', '二', '三', '四', '五', '六'] : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                const dayCell = this.createElement('th', {
                    position: 'relative',
                    background: '#f6f6f6',
                    width: `calc((100% / ${daysOfWeek.length})`,
                    height: '46px',
                    padding: '4px',
                    textAlign: 'center',
                    border: '1px solid #e6e6e6',
                    boxSizing: 'border-box',
                });
                dayCell.textContent = day;
                headerRow.appendChild(dayCell);
            });
            
            headerTable.appendChild(headerRow);
            this.fixedHeader.appendChild(headerTable);
        }
    }

    setLeft() {
        this.fixedLeft.innerHTML = '';
        const leftTable = this.createElement('table', { width: '100%', borderCollapse: 'collapse' }); 
        let currentTime = this.startHm;
        while (currentTime <= this.endHm) {
            const row = this.createElement('tr');
            const cell = this.createElement('th', {
                position: 'relative',
                background: '#f6f6f6',
                width: '60px',
                height: '30px',
                padding: '4px',
                border: '1px solid #e6e6e6',
                boxSizing: 'border-box',
                textAlign: 'center',
            });
            
            const timeString = currentTime.toString().padStart(4, '0');
            const formattedTime = `${timeString.slice(0, 2)}:${timeString.slice(2)}`;
            cell.innerHTML = `${formattedTime}`;
            
            row.appendChild(cell);
            leftTable.appendChild(row);
            currentTime = this.getNextTimeSlot(currentTime, this.interval);
        }
        
        this.fixedLeft.appendChild(leftTable);
    }

    setSlots() {
        this.timeSlots.innerHTML = '';
        const timeSlotsTable = this.createElement('table', { width: '100%', borderCollapse: 'collapse' });
        
        let currentTime = this.startHm;
        while (currentTime <= this.endHm) {
            const row = this.createElement('tr');
            if (this.resources) {
                this.resources.forEach((resource, index) => {
                    const startOfWeek = new Date(this.displayDate);
                    if (this.displayMode === 'week') {
                        for (let w = 0; w < 7; w++) {
                            const day = new Date(startOfWeek);
                            day.setDate(startOfWeek.getDate() + w);
                            const cell = this.createElement('td', {
                                position: 'relative',
                                background: '#fff',
                                width: `calc((100% - 60px) / ${this.resources.length})`,
                                minWidth: '180px',
                                height: '30px',
                                padding: '4px',
                                border: '1px solid #e6e6e6',
                                boxSizing: 'border-box',
                            });
                            cell.setAttribute('data-timeslot', `${resource.id}_` + this.getYmd(day) + `_${currentTime}`);
                            row.appendChild(cell);
                        }
                    } else {
                        const cell = this.createElement('td', {
                            position: 'relative',
                            background: '#fff',
                            width: `calc((100% - 60px) / ${this.resources.length})`,
                            minWidth: '180px',
                            height: '30px',
                            padding: '4px',
                            border: '1px solid #e6e6e6',
                            boxSizing: 'border-box',
                        });
                        cell.setAttribute('data-timeslot', `${resource.id}_` + this.getYmd(startOfWeek) + `_${currentTime}`);
                        row.appendChild(cell);
                    }
                });
            }

            timeSlotsTable.appendChild(row);
            currentTime = this.getNextTimeSlot(currentTime, this.interval);
        }
        
        this.timeSlots.appendChild(timeSlotsTable);
    }

    syncScroll() {
        this.timeSlots.onscroll = () => {
            this.fixedHeader.querySelector('table').style.transform = `translateX(${-this.timeSlots.scrollLeft}px)`;
            this.fixedLeft.querySelector('table').style.transform = `translateY(${-this.timeSlots.scrollTop}px)`
        };
    }

    drawEvents(events) {
        this.events = events;
        
        // Clear all existing events
        this.timeSlots.querySelectorAll('.ievent').forEach(event => event.remove());

        if (events) {
            events.forEach(event => {
                // Find the matching slot using the event's resourceId, targetDate, and startHm
                const findMatchSlot = this.timeSlots.querySelector(`[data-timeslot="${event.resourceId}_${event.targetDate}_${Math.max(this.startHm, event.startHm)}"]`);
                if (findMatchSlot) {
                    // Count how many blocks are already present in the slot to determine the position
                    const blockCount = findMatchSlot.querySelectorAll('.ievent').length;
                    
                    // Convert startHm and endHm to minutes since midnight
                    const startMinutes = Math.floor(Math.max(this.startHm, event.startHm) / 100) * 60 + (Math.max(this.startHm, event.startHm) % 100);
                    const endMinutes = Math.floor(Math.min(this.endHm, event.endHm) / 100) * 60 + (Math.min(this.endHm, event.endHm) % 100);

                    // Calculate the duration in minutes
                    const durationMinutes = endMinutes - startMinutes;

                    // Calculate the height based on the number of intervals
                    const height = (Math.ceil(durationMinutes / this.interval) + 1) * 30;

                    // Create a new event block
                    const block = this.createElement('div', {
                        position: 'absolute',
                        background: event.background || '#3788d8',
                        top: '0px',
                        left: `${blockCount * 40}px`,
                        right: '0px',
                        height: `${height}px`,
                        padding: '8px',
                        border: '1px solid #e6e6e6',
                        boxSizing: 'border-box',
                        borderRadius: '8px',
                        overflow: 'hidden',
                        textAlign: 'center',
                        opacity: '0.95',
                        zIndex: 1
                    }, 'ievent');

                    // Set the event content
                    block.innerHTML = `<div>${event.content}</div>`;

                    // Append the block to the matching slot
                    findMatchSlot.appendChild(block);
                }
            });
        }
    }
    
    refresh() {
        document.getElementById('icalendar-showdate').innerHTML = this.getDisplayDate();
        this.setHeader();
        this.setLeft();
        this.setSlots();
        this.drawEvents(this.events);
    }

    getYmd(date, included_week) {
        // Convert the localized time back to a Date object
        const hongKongDate = new Date(date);

        // Define config to format the date including the weekday
        // Location code: en-US or zh-HK
        const formatter = new Intl.DateTimeFormat(((this.lang === 'zh')?'zh-HK':'en-US'), {
            timeZone: 'Asia/Hong_Kong',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            weekday: 'short' // Add weekday to display day of the week
        });

        // Extract the date parts including the weekday
        const parts = formatter.formatToParts(hongKongDate);
        const year = parts.find(part => part.type === 'year').value;
        const month = parts.find(part => part.type === 'month').value;
        const day = parts.find(part => part.type === 'day').value;
        const weekday = parts.find(part => part.type === 'weekday').value.replace('星期', '').replace('週', '');  
        
        if(included_week) {
            return `${year}-${month}-${day} (${weekday})`;
            
        }
        else {
            return `${year}-${month}-${day}`;
        }
    }
    
    // calculate the next timeslot and handle minute overflow
    getNextTimeSlot(hm, interval) {
        let nextHm = hm + interval;
        if (nextHm % 100 >= 60) {
            nextHm = (Math.floor(nextHm / 100) + 1) * 100 + (nextHm % 100 - 60);
        }
        return nextHm;
    }
}
    
    
// Usage Example
const resources = [
    { id: 1, name: '會議室 A' },
    { id: 2, name: '會議室 B' },
    { id: 3, name: '會議室 C' },
    { id: 4, name: '會議室 D' },
    { id: 5, name: '會議室 E' }
];

const events = [
    { resourceId: 1, targetDate: '2024-09-03', startHm: 715, endHm: 950, content: '07:15 ~ 09:50', background: '#FFA726' },
    { resourceId: 1, targetDate: '2024-09-04', startHm: 815, endHm: 950, content: '08:15 ~ 09:50', background: '#FFA156' },
    { resourceId: 2, targetDate: '2024-09-03', startHm: 1000, endHm: 2250, content: '10:00 ~ 22:50', background: '#2A9D8F' },
    { resourceId: 3, targetDate: '2024-09-03', startHm: 1330, endHm: 1430, content: '13:30 ~ 14:30' },
    { resourceId: 1, targetDate: '2024-09-03', startHm: 915, endHm: 1045, content: '09:15 ~ 10:45', background: '#4C7B96' },
    { resourceId: 2, targetDate: '2024-09-03', startHm: 1000, endHm: 1430, content: '10:00 ~ 14:30' },
];
const icalendar = new iCalendar({ displayMode: 'week', date: '2024-09-03', startHm: 800, endHm: 2200, interval: 5, maxHeight: 680, lang: 'zh' });
icalendar.init(resources, events);
</script>
</body>
</html>
